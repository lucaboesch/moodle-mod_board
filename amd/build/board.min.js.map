{"version":3,"sources":["../src/board.js"],"names":["_serviceCall","method","args","callback","failcallback","Ajax","call","methodname","done","data","fail","error","Notification","exception","isAriaTriggerKey","key","encodeText","rawText","text","html","decodeText","encodedText","handleAction","elem","on","e","type","keyCode","preventDefault","handleEditableAction","callBeforeOnKeyEditing","is","Error","editable","board","options","strings","default_column_heading","post_button_text","cancel_button_text","remove_note_title","remove_note_text","remove_column_title","remove_column_text","note_changed_title","note_changed_text","note_deleted_text","rate_note_text","Ok","Cancel","warning","option_youtube","option_youtube_info","option_youtube_url","option_image","option_image_info","option_image_url","option_link","option_link_info","option_link_url","option_empty","aria_newcolumn","aria_newpost","aria_deletecolumn","aria_deletepost","aria_addmedia","aria_addmedianew","aria_deleteattachment","aria_postedit","aria_canceledit","aria_postnew","aria_cancelnew","aria_choosefilenew","aria_choosefileedit","aria_ratepost","choose_file","invalid_file_extension","invalid_file_size_min","invalid_file_size_max","MEDIA_SELECTION_BUTTONS","ATTACHMENT_VIDEO","ATTACHMENT_IMAGE","ATTACHMENT_LINK","SORTBY_DATE","SORTBY_RATING","reloadTimer","lastHistoryId","isEditor","userId","mediaSelection","mediaselection","noteTextCache","noteHeadingCache","attachmentCache","editingNote","isReadOnlyBoard","readonly","acceptedFileExtensions","file","extensions","acceptedFileSizeMin","size_min","acceptedFileSizeMax","size_max","ratingenabled","sortby","serviceCall","stopUpdating","apply","arguments","updateBoard","getNote","ident","getNoteText","getNoteTextForNote","note","find","getNoteHeading","getNoteHeadingForNote","getNoteButtonsForNote","showNewNoteButtons","show","hideNewNoteButtons","hide","getNoteAttachmentsForNote","textIdentifierForNote","noteText","noteHeading","noteAttachment","attachmentDataForNote","length","replace","split","slice","join","info","updateNoteAria","noteId","columnIdentifier","closest","postButton","cancelButton","addYoutube","addImage","addLink","removeAttachment","chooseFileButton","noteIdentifier","attr","attRemove","updateColumnAria","columnId","column","each","index","successNoteEdit","stopNoteEdit","remove","setAttachment","previewAttachment","startNoteEdit","pendingNote","deleteNote","confirm","id","result","status","historyid","rateNote","rating","canrate","sortNotes","attachmentTypeChanged","val","attachmentInfo","attachmentUrl","attachmentFile","attachmentIcon","prop","attachmentTypeToString","FileReader","removeClass","addClass","attachmentFAIcon","attachment","attType","url","filename","filecontents","fileElem","attachmentFAIcons","preloadFile","indexOf","name","pop","toLowerCase","alert","size","fr","onload","readAsDataURL","fixEmbedUrlIfNeeded","parseInt","addNote","columnid","heading","content","owner","sortorder","ismynote","iseditable","notecontent","noteAriaText","attachmentPreview","append","attachmentType","attachmentFileInput","trigger","column_content","buttons","postbutton","cancelbutton","ytButton","imgButton","linkButton","removeElement","beginEdit","sendAttach","theHeading","theText","substring","post_max_length","userid","timecreated","toggleFontSize","closeOnEnter","rateElement","lastOne","last","insertAfter","prepend","addColumn","notes","nameCache","columnHeader","columnSort","columnName","columnContent","columnNewContent","hideheaders","noteicon","updateSortable","addNewColumnButton","newBusy","columnicon","boardid","updateNote","processBoardHistory","since","boardhistory","item","JSON","parse","action","instant","history_refresh","setTimeout","clearTimeout","toggle","sortCol","parent","direction","desc","asc","a","b","sort","appendTo","sortable","connectWith","stop","ui","tocolumn","init","columns","stringsInfo","string","push","component","$","when","results"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to handle the board.\n *\n * @package    mod_board\n * @author     Karen Holland <karen@brickfieldlabs.ie>\n * @copyrigt   2021 Brickfield Education Labs <https://www.brickfield.ie/>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from \"jquery\";\nimport \"jqueryui\";\nimport {get_strings as getStrings} from \"core/str\";\nimport Ajax from \"core/ajax\";\nimport Notification from \"core/notification\";\nimport \"mod_board/jquery.editable.amd\";\n\n/**\n * Execute a ajax call to a mod_board ajax service.\n *\n * @method _serviceCall\n * @param method\n * @param args\n * @param callback\n * @param failcallback\n * @private\n */\nconst _serviceCall = function(method, args, callback, failcallback) {\n    Ajax.call([{\n        methodname: 'mod_board_' + method,\n        args: args,\n        done: function(data) {\n            callback(data);\n        },\n        fail: function(error) {\n            Notification.exception(error);\n            if (failcallback) {\n                failcallback(error);\n            }\n        }\n    }]);\n};\n\n/**\n * Indicates if this is a keycode we want to listend to for\n * aria purposes.\n *\n * @method isAriaTriggerKey\n * @param key\n * @returns {boolean}\n */\nconst isAriaTriggerKey = function(key) {\n    return key == 13 || key == 32;\n};\n\n/**\n * Encodes text into html entities.\n *\n * @method encodeText\n * @param rawText\n * @returns {*|jQuery}\n */\nconst encodeText = function(rawText) {\n    return $('<div />').text(rawText).html();\n};\n\n/**\n * Decodes text from html entities.\n *\n * @method decodeText\n * @param encodedText\n * @returns {*|jQuery}\n */\nconst decodeText = function(encodedText) {\n    return $('<div />').html(encodedText).text();\n};\n\n/**\n * Handler for keypress and click actions.\n *\n * $method handleAction\n * @param elem\n * @param callback\n * @returns {*}\n */\nconst handleAction = function(elem, callback) {\n    return elem.on('click keypress', function(e) {\n        if (e.type == 'keypress') {\n            if (isAriaTriggerKey(e.keyCode)) {\n                e.preventDefault();\n            } else {\n                return;\n            }\n        }\n\n        callback();\n    });\n};\n\n/**\n * Setting up element edibility.\n *\n * @method handleEditableAction\n * @param elem\n * @param callback\n * @param callBeforeOnKeyEditing\n * @returns {*}\n */\nconst handleEditableAction = function(elem, callback, callBeforeOnKeyEditing) {\n    if (elem.is(':editable')) {\n        throw new Error('handleEditableAction - must be called before setting the element as editable');\n    }\n\n    // Can't use on(edit) here because we want to do actions (save cache) before the control goes into edit mode\n    return elem.on('dblclick keypress', function(e) {\n        if (e.type == 'keypress') {\n            if (isAriaTriggerKey(e.keyCode) && !elem.is(':editing')) {\n                e.preventDefault();\n                if (callBeforeOnKeyEditing) {\n                    callback();\n                }\n                elem.editable('open');\n                if (callBeforeOnKeyEditing) {\n                    return;\n                }\n            } else {\n                return;\n            }\n        }\n\n        callback();\n    });\n};\n\n/**\n * The default function of the module, which does the setup of the page.\n *\n * @param board\n * @param options\n */\nexport default function(board, options) {\n    // An array of strings to load as a batch later.\n    // Not necessary, but used to load all the strings in one ajax call.\n    var strings = {\n        default_column_heading: '',\n        post_button_text: '',\n        cancel_button_text: '',\n        remove_note_title: '',\n        remove_note_text: '',\n        remove_column_title: '',\n        remove_column_text: '',\n        note_changed_title: '',\n        note_changed_text: '',\n        note_deleted_text: '',\n        rate_note_text: '',\n        Ok: '',\n        Cancel: '',\n        warning: '',\n        option_youtube: '',\n        option_youtube_info: '',\n        option_youtube_url: '',\n        option_image: '',\n        option_image_info: '',\n        option_image_url: '',\n        option_link: '',\n        option_link_info: '',\n        option_link_url: '',\n        option_empty: '',\n\n        aria_newcolumn: '',\n        aria_newpost: '',\n        aria_deletecolumn: '',\n        aria_deletepost: '',\n        aria_addmedia: '',\n        aria_addmedianew: '',\n        aria_deleteattachment: '',\n        aria_postedit: '',\n        aria_canceledit: '',\n        aria_postnew: '',\n        aria_cancelnew: '',\n        aria_choosefilenew: '',\n        aria_choosefileedit: '',\n        aria_ratepost: '',\n\n        choose_file: '',\n        invalid_file_extension: '',\n        invalid_file_size_min: '',\n        invalid_file_size_max: '',\n    };\n\n    const MEDIA_SELECTION_BUTTONS = 1,\n          MEDIA_SELECTION_DROPDOWN = 2,\n          ATTACHMENT_VIDEO = 1,\n          ATTACHMENT_IMAGE = 2,\n          ATTACHMENT_LINK = 3,\n          SORTBY_DATE = 1,\n          SORTBY_RATING = 2;\n    var reloadTimer = null,\n        lastHistoryId = null,\n        isEditor = options.isEditor || false,\n        userId = options.userId || -1,\n        mediaSelection = options.mediaselection || MEDIA_SELECTION_BUTTONS,\n        noteTextCache = null,\n        noteHeadingCache = null,\n        attachmentCache = null,\n        editingNote = 0,\n        isReadOnlyBoard = options.readonly || false,\n        acceptedFileExtensions = options.file.extensions,\n        acceptedFileSizeMin = options.file.size_min,\n        acceptedFileSizeMax = options.file.size_max,\n        ratingenabled = options.ratingenabled,\n        sortby = options.sortby || SORTBY_DATE;\n\n    /**\n     * Helper method to make calles to mod_board external services.\n     *\n     * @method serviceCall\n     * @param method\n     * @param args\n     * @param callback\n     * @param failcallback\n     */\n    var serviceCall = function(method, args, callback, failcallback) {\n        if (method !== 'board_history') {\n            stopUpdating();\n        }\n        _serviceCall(method, args, function() {\n            callback.apply(null, arguments);\n            if (method !== 'board_history' && method != 'get_board') {\n                updateBoard(true);\n            }\n        }, failcallback);\n    };\n\n    /**\n     * Returns the jquery element of a given note identifier.\n     *\n     * @method getNote\n     * @param ident\n     * @returns {jQuery|HTMLElement|*}\n     */\n    var getNote = function(ident) {\n        return $(\".board_note[data-ident='\" + ident + \"']\");\n    };\n\n    /**\n     * Returns the jquery element of the note text for the given note identifier.\n     *\n     * @method getNoteText\n     * @param ident\n     * @returns {jQuery|HTMLElement|*}\n     */\n    var getNoteText = function(ident) {\n        return $(\".board_note[data-ident='\" + ident + \"'] .mod_board_note_text\");\n    };\n\n    /**\n     * Returns the jquery element of the note text for the given note element.\n     *\n     * @method getNoteTextForNote\n     * @param note\n     * @returns {*|jQuery}\n     */\n    var getNoteTextForNote = function(note) {\n        return $(note).find(\".mod_board_note_text\");\n    };\n\n    /**\n     * Returns the jquery element of the note heading for the given note identifier.\n     *\n     * @method getNoteHeading\n     * @param ident\n     * @returns {jQuery|HTMLElement|*}\n     */\n    var getNoteHeading = function(ident) {\n        return $(\".board_note[data-ident='\" + ident + \"'] .mod_board_note_heading\");\n    };\n\n    /**\n     * Returns the jquery element of the note heading for the given note element.\n     *\n     * @method getNoteHeadingForNote\n     * @param note\n     * @returns {*|jQuery}\n     */\n    var getNoteHeadingForNote = function(note) {\n        return $(note).find(\".mod_board_note_heading\");\n    };\n\n    /**\n     * Returns the jquery element of the note buttons for the given note element.\n     *\n     * @method getNoteButtonsForNote\n     * @param note\n     * @returns {*|jQuery}\n     */\n    var getNoteButtonsForNote = function(note) {\n        return $(note).find(\".mod_board_note_buttons\");\n    };\n\n    /**\n     * Shows the buttons creation new notes.\n     *\n     * @method showNewNoteButtons\n     */\n    var showNewNoteButtons = function() {\n        $('.board_column .board_column_newcontent .board_button.newnote').show();\n    };\n\n    /**\n     * Hides the buttons for creating new notes.\n     *\n     * @method hideNewNoteButtons\n     */\n    var hideNewNoteButtons = function() {\n        $('.board_column .board_column_newcontent .board_button.newnote').hide();\n    };\n\n    /**\n     * Gets a jquery node for the attachments of a given note.\n     *\n     * @method getNoteAttachmentsForNote\n     * @param note\n     * @returns {*|jQuery}\n     */\n    var getNoteAttachmentsForNote = function(note) {\n        return $(note).find(\".mod_board_note_attachment\");\n    };\n\n    /**\n     * Creates text identifier for a given node.\n     *\n     * @method textIdentifierForNote\n     * @param note\n     * @returns {null|*|jQuery}\n     */\n    var textIdentifierForNote = function(note) {\n        var noteText = getNoteTextForNote(note).html(),\n            noteHeading = getNoteHeadingForNote(note).html(),\n            noteAttachment = attachmentDataForNote(note);\n\n        if (noteHeading.length > 0) {\n            return noteHeading;\n        }\n        if (noteText.length > 0) {\n            return noteText.replace(/<br\\s*\\/?>/gi, \" \").replace(/\\n/g, \" \").split(/\\s+/).slice(0, 5).join(\" \");\n        }\n        if (noteAttachment.info && noteAttachment.info.length > 0) {\n            return noteAttachment.info;\n        }\n        return null;\n    };\n\n    /**\n     * Update the Aria info for a given note id.\n     *\n     * @method updateNoteAria\n     * @param noteId\n     */\n    var updateNoteAria = function(noteId) {\n        var note = getNote(noteId),\n            columnIdentifier = note.closest('.board_column').find('.mod_board_column_name').text(),\n            postButton = \"\",\n            cancelButton = \"\",\n            addYoutube = \"\",\n            addImage = \"\",\n            addLink = \"\",\n            removeAttachment = \"\",\n            chooseFileButton = \"\";\n\n        if (!noteId) { // New post\n            postButton = strings.aria_postnew.replace('{column}', columnIdentifier);\n            cancelButton = strings.aria_cancelnew.replace('{column}', columnIdentifier);\n            addYoutube = strings.aria_addmedianew.replace('{type}', strings.option_youtube).replace('{column}',\n                          columnIdentifier);\n            addImage = strings.aria_addmedianew.replace('{type}', strings.option_image).replace('{column}', columnIdentifier);\n            addLink = strings.aria_addmedianew.replace('{type}', strings.option_link).replace('{column}', columnIdentifier);\n            chooseFileButton = strings.aria_choosefilenew.replace('{column}', strings.columnIdentifier);\n        } else {\n            var noteIdentifier = textIdentifierForNote(note);\n\n            postButton = strings.aria_postedit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\n            cancelButton = strings.aria_canceledit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\n            addYoutube = strings.aria_addmedia.replace('{type}', strings.option_youtube).replace('{column}',\n                          columnIdentifier).replace('{post}', noteIdentifier);\n            addImage = strings.aria_addmedia.replace('{type}', strings.option_image).replace('{column}',\n                          columnIdentifier).replace('{post}', noteIdentifier);\n            addLink = strings.aria_addmedia.replace('{type}', strings.option_link).replace('{column}',\n                          columnIdentifier).replace('{post}', noteIdentifier);\n            removeAttachment = strings.aria_deleteattachment.replace('{column}',\n            columnIdentifier).replace('{post}', noteIdentifier);\n            chooseFileButton = strings.aria_choosefileedit.replace('{column}',\n            columnIdentifier).replace('{post}', noteIdentifier);\n\n            note.find('.delete_note').attr('aria-label', strings.aria_deletepost.replace('{column}',\n                columnIdentifier).replace('{post}', noteIdentifier));\n            note.find('.mod_board_rating').attr('aria-label', strings.aria_ratepost.replace('{column}',\n                columnIdentifier).replace('{post}', noteIdentifier));\n            note.find('.note_ariatext').html(noteIdentifier);\n        }\n\n        // Attach media buttons, if set.\n        if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n            if (noteId) {\n                var attRemove = note.find('.mod_board_remove_attachment');\n                if (attRemove) {\n                    attRemove.attr('aria-label', removeAttachment);\n                }\n            }\n\n            note.find('.mod_board_attachment_button.youtube_button').attr('aria-label', addYoutube);\n            note.find('.mod_board_attachment_button.image_button').attr('aria-label', addImage);\n            note.find('.mod_board_attachment_button.link_button').attr('aria-label', addLink);\n        }\n        note.find('.post_button').attr('aria-label', postButton);\n        note.find('.cancel_button').attr('aria-label', cancelButton);\n        note.find('.choose_file_button').attr('aria-label', chooseFileButton);\n    };\n\n    /**\n     * Update the Aria information for a given column id.\n     *\n     * @method updateColumnAria\n     * @param columnId\n     */\n    var updateColumnAria = function(columnId) {\n        var column = $('.board_column[data-ident=' + columnId + ']'),\n            columnIdentifier = column.find('.mod_board_column_name').text();\n        column.find('.newnote').attr('aria-label', strings.aria_newpost.replace('{column}', columnIdentifier));\n        column.find('.delete_column').attr('aria-label', strings.aria_deletecolumn.replace('{column}', columnIdentifier));\n\n        column.find(\".board_note\").each(function(index, note) {\n            updateNoteAria($(note).data('ident'));\n        });\n    };\n\n    /**\n     * Clean things up after successfully editing a note.\n     *\n     * @method successNoteEdit\n     */\n    var successNoteEdit = function() {\n        noteTextCache = null;\n        noteHeadingCache = null;\n        attachmentCache = null;\n        stopNoteEdit();\n    };\n\n    /**\n     * Stop the current note editing process.\n     *\n     * @method stopNoteEdit\n     */\n    var stopNoteEdit = function() {\n        if (!editingNote) {\n            getNote(0).remove();\n            showNewNoteButtons();\n            return;\n        }\n\n        if (noteTextCache) {\n            getNoteText(editingNote).html(noteTextCache);\n            noteTextCache = null;\n        }\n\n        if (noteHeadingCache) {\n            getNoteHeading(editingNote).html(noteHeadingCache);\n            noteHeadingCache = null;\n        }\n\n        var note = getNote(editingNote);\n\n        if (note) {\n            if (attachmentCache) {\n                setAttachment(note, attachmentCache);\n                attachmentCache = null;\n            } else {\n                previewAttachment(note);\n            }\n\n            getNoteButtonsForNote(note).hide();\n            getNoteAttachmentsForNote(note).hide();\n            showNewNoteButtons();\n            var noteHeading = getNoteHeadingForNote(note);\n            if (!noteHeading.html()) {\n                noteHeading.hide();\n            }\n        }\n\n        editingNote = 0;\n    };\n\n    /**\n     * Start the editing of a particular note, by identifier.\n     *\n     * @method startNoteEdit\n     * @param ident\n     */\n    var startNoteEdit = function(ident) {\n        if (editingNote) {\n            if (editingNote == ident) {\n                return;\n            }\n            stopNoteEdit();\n        }\n\n        if (ident) {\n            var pendingNote = getNote(0);\n            if (pendingNote) {\n                pendingNote.remove();\n            }\n        }\n\n        var note = getNote(ident);\n        if (note) {\n            getNoteButtonsForNote(note).show();\n            getNoteAttachmentsForNote(note).show();\n            hideNewNoteButtons();\n\n            var noteHeading = getNoteHeadingForNote(note);\n            if (ident) {\n                attachmentCache = attachmentDataForNote(note);\n                noteTextCache = getNoteTextForNote(note).html();\n                noteHeadingCache = noteHeading.html();\n                editingNote = ident;\n            }\n            noteHeading.show();\n        }\n    };\n\n    /**\n     * Delete a given note, by identifier.\n     *\n     * @method deleteNote\n     * @param ident\n     */\n    var deleteNote = function(ident) {\n        Notification.confirm(\n            strings.remove_note_title,\n            strings.remove_note_text,\n            strings.Ok,\n            strings.Cancel,\n            function() {\n                serviceCall('delete_note', {id: ident}, function(result) {\n                    if (result.status) {\n                        lastHistoryId = result.historyid;\n                        getNote(ident).remove();\n                    }\n                });\n            }\n        );\n    };\n\n    /**\n     * Rate (star) a give note, by identifier.\n     *\n     * @method rateNote\n     * @param ident\n     */\n    var rateNote = function(ident) {\n        if (!ratingenabled) {\n            return;\n        }\n        if (isReadOnlyBoard) {\n            return;\n        }\n\n        var note = getNote(ident),\n            rating = note.find('.mod_board_rating');\n        if (rating.data('disabled')) {\n            return;\n        }\n        rating.data('disabled', true);\n\n        serviceCall('can_rate_note', {id: ident}, function(canrate) {\n            if (canrate) {\n                Notification.confirm(\n                    strings.rate_note_text, // Are you sure?\n                    null,\n                    strings.Ok,\n                    strings.Cancel,\n                    function() {\n                        serviceCall('rate_note', {id: ident}, function(result) {\n                            if (result.status) {\n                                lastHistoryId = result.historyid;\n                                rating.html(result.rating);\n                                if (sortby == SORTBY_RATING) {\n                                    sortNotes(note.closest('.board_column_content'));\n                                }\n                            }\n                            rating.data('disabled', false);\n                        });\n                    }\n                );\n\n            }\n        });\n    };\n\n    /**\n     * Update the attachment information of a note.\n     *\n     * @method attachmentTypeChanged\n     * @param note\n     */\n    var attachmentTypeChanged = function(note) {\n        var noteAttachment = getNoteAttachmentsForNote(note),\n            type = noteAttachment.find('.mod_board_type').val(),\n            attachmentInfo = noteAttachment.find('.info'),\n            attachmentUrl = noteAttachment.find('.url'),\n            attachmentFile = noteAttachment.find('.mod_board_file');\n\n        if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n            var attachmentIcon = noteAttachment.find('.mod_board_type_icon'),\n                removeAttachment = noteAttachment.find('.mod_board_remove_attachment');\n        } else {\n            getNoteButtonsForNote(note).find('.mod_board_attachment_button').hide();\n        }\n\n        if (type > \"0\") {\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                removeAttachment.show();\n            }\n            attachmentInfo.prop('placeholder', strings['option_' + attachmentTypeToString(type) + '_info']);\n            attachmentUrl.prop('placeholder', strings['option_' + attachmentTypeToString(type) + '_url']);\n\n            attachmentInfo.show();\n            if (type == ATTACHMENT_IMAGE && FileReader) {\n                attachmentFile.show();\n                attachmentUrl.hide();\n            } else {\n                attachmentFile.hide();\n                attachmentUrl.show();\n            }\n\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                attachmentIcon.removeClass().addClass(['mod_board_type_icon', 'fa', attachmentFAIcon(type)]);\n                attachmentIcon.show();\n                getNoteButtonsForNote(note).find('.mod_board_attachment_button').hide();\n            }\n        } else {\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                removeAttachment.hide();\n            }\n            attachmentInfo.hide();\n            attachmentUrl.hide();\n            attachmentFile.hide();\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                attachmentIcon.hide();\n            }\n            attachmentInfo.val('');\n            attachmentUrl.val('');\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                getNoteButtonsForNote(note).find('.mod_board_attachment_button').show();\n            }\n        }\n    };\n\n    /**\n     * Set the attachment of a note.\n     *\n     * @method setAttachment\n     * @param note\n     * @param attachment\n     */\n    var setAttachment = function(note, attachment) {\n        var noteAttachment = getNoteAttachmentsForNote(note);\n        if (noteAttachment) {\n            if (!attachment) {\n                attachment = {type: \"0\"};\n            } else {\n                attachment.type += \"\";// Just in case\n            }\n            var attType = noteAttachment.find('.mod_board_type');\n            attType.val(attachment.type ? attachment.type : \"0\");\n            if (attType.val() > \"0\") {\n                noteAttachment.find('.info').val(decodeText(attachment.info));\n                noteAttachment.find('.url').val(decodeText(attachment.url));\n            }\n            attachmentTypeChanged(note, attachment);\n        }\n        previewAttachment(note, attachment);\n    };\n\n    /**\n     * Returns an object with various information about a note's attachment.\n     *\n     * @method attachmentDataForNote\n     * @param note\n     * @returns {{filename: null, filecontents: null, type: number, url: null, info: null}}\n     */\n    var attachmentDataForNote = function(note) {\n        var attachment = {type: 0, info: null, url: null, filename: null, filecontents: null},\n            noteAttachment = getNoteAttachmentsForNote(note);\n        if (noteAttachment.length) {\n            attachment.type = noteAttachment.find('.mod_board_type').val();\n            attachment.info = encodeText(noteAttachment.find('.info').val());\n            attachment.url = encodeText(noteAttachment.find('.url').val());\n            var fileElem = noteAttachment.find('.mod_board_file>input');\n            if (fileElem.data('filename')) {\n                attachment.filename = fileElem.data('filename');\n                attachment.filecontents = fileElem.data('filecontents');\n            }\n        }\n        if ((!attachment.info || !attachment.info.length) && (!attachment.url || !attachment.url.length) &&\n            (!attachment.filename)) {\n            attachment.type = 0;\n        }\n\n        return attachment;\n    };\n\n    /**\n     * Get the string type of a attachment type number.\n     *\n     * @method attachmentTypeToString\n     * @param type\n     * @returns {string|null}\n     */\n    var attachmentTypeToString = function(type) {\n        switch (type) {\n            case \"1\": return 'youtube';\n            case \"2\": return 'image';\n            case \"3\": return 'link';\n            default: return null;\n        }\n    };\n\n    var attachmentFAIcons = ['fa-youtube', 'fa-picture-o', 'fa-link'];\n    /**\n     * Get the fa icon for a given numeric attachment type.\n     *\n     * @method attachmentFAIcon\n     * @param type\n     * @returns {string|null}\n     */\n    var attachmentFAIcon = function(type) {\n        return attachmentFAIcons[type - 1] || null;\n    };\n\n    /**\n     * Attempt to preload a give note file.\n     *\n     * @method preloadFile\n     * @param note\n     * @param callback\n     */\n    var preloadFile = function(note, callback) {\n        var noteAttachment = getNoteAttachmentsForNote(note);\n        if (noteAttachment.length) {\n            var fileElem = noteAttachment.find('.mod_board_file>input');\n            if (FileReader && fileElem.prop('files').length) {\n                var file = fileElem.prop('files')[0];\n                if (acceptedFileExtensions.indexOf(file.name.split('.').pop().toLowerCase()) == -1) { // Wrong exception\n                    Notification.alert(strings.warning, strings.invalid_file_extension);\n                } else if (file.size < acceptedFileSizeMin) {\n                    Notification.alert(strings.warning, strings.invalid_file_size_min);\n                } else if (file.size > acceptedFileSizeMax) {\n                    Notification.alert(strings.warning, strings.invalid_file_size_max);\n                } else {\n                    fileElem.data('filename', file.name);\n                    var fr = new FileReader();\n                    fr.onload = function() {\n                        fileElem.data('filecontents', fr.result);\n                        callback();\n                        fileElem.val('');\n                    };\n                    fr.readAsDataURL(file);\n                }\n            } else {\n                callback();\n            }\n        } else {\n            callback();\n        }\n    };\n\n    /**\n     * Display the attachment preview for a note.\n     *\n     * @method previewAttachment\n     * @param note\n     * @param attachment\n     */\n    var previewAttachment = function(note, attachment) {\n        var elem = note.find('.mod_board_preview');\n        if (!attachment) {\n            attachment = attachmentDataForNote(note);\n        }\n        var fixEmbedUrlIfNeeded = function(url) {\n            return url.replace(/watch\\?v=/gi, '/embed/').replace(/youtu\\.be/, 'youtube.com/embed');\n        };\n\n        if (!getNoteTextForNote(note).html().length) {\n            elem.addClass('mod_board_notext');\n        } else {\n            elem.removeClass('mod_board_notext');\n        }\n\n        elem.removeClass('wrapper_youtube');\n        elem.removeClass('wrapper_image');\n        elem.removeClass('wrapper_url');\n        if (attachment.filename && parseInt(attachment.type) == ATTACHMENT_IMAGE) { // Before uploading\n            elem.html('<img src=\"' + attachment.filecontents + '\" class=\"mod_board_preview_element\" alt=\"' +\n            attachment.info + '\"/>');\n            elem.addClass('wrapper_image');\n            elem.show();\n        } else if (attachment.url) {\n            switch (parseInt(attachment.type)) {\n                case ATTACHMENT_VIDEO: // Youtube\n                    elem.html('<iframe src=\"' + fixEmbedUrlIfNeeded(attachment.url) +\n                    '\" class=\"mod_board_preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write;' +\n                    'encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>');\n                    elem.addClass('wrapper_youtube');\n                    elem.show();\n                break;\n                case ATTACHMENT_IMAGE: // Image\n                    elem.html('<img src=\"' + attachment.url + '\" class=\"mod_board_preview_element\" alt=\"' +\n                    attachment.info + '\"/>');\n                    elem.addClass('wrapper_image');\n                    elem.show();\n                break;\n                case ATTACHMENT_LINK: // Url\n                    elem.html('<a href=\"' + attachment.url + '\" class=\"mod_board_preview_element\" target=\"_blank\">' +\n                             (attachment.info || attachment.url) + '</a>');\n                    elem.addClass('wrapper_url');\n                    elem.show();\n                break;\n                default:\n                    elem.html('');\n                    elem.hide();\n            }\n        } else {\n            elem.html('');\n            elem.hide();\n        }\n    };\n\n    /**\n     * Add a new note with the given information.\n     *\n     * @method addNote\n     * @param columnid\n     * @param ident\n     * @param heading\n     * @param content\n     * @param attachment\n     * @param owner\n     * @param sortorder\n     * @param rating\n     */\n    var addNote = function(columnid, ident, heading, content, attachment, owner, sortorder, rating) {\n        var ismynote = owner.id == userId || !ident;\n        var iseditable = isEditor || (ismynote && !isReadOnlyBoard);\n\n        if (!ident) {\n            var pendingNote = getNote(0);\n            if (pendingNote) {\n                pendingNote.remove();\n            }\n        }\n\n        var note = $('<div class=\"board_note\" data-ident=\"' + ident + '\" data-sortorder=\"' + sortorder + '\"></div>');\n        if (ismynote) {\n            note.addClass('mod_board_mynote');\n        }\n        if (iseditable) {\n            note.addClass('mod_board_editablenote');\n        }\n\n        var notecontent = $('<div class=\"mod_board_note_content\"></div>'),\n            noteHeading = $('<div class=\"mod_board_note_heading\" tabindex=\"0\">' + (heading ? heading : '') + '</div>'),\n            noteText = $('<div class=\"mod_board_note_text\" tabindex=\"0\">' + (content ? content : '') + '</div>'),\n            noteAriaText = $('<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>'),\n            attachmentPreview = $('<div class=\"mod_board_preview\"></div>');\n        if (iseditable) {\n            var noteAttachment = $('<div class=\"mod_board_note_attachment form-group row\" tabindex=\"0\">' +\n                                '<select class=\"mod_board_type form-control form-control-sm ' +\n                                (mediaSelection == MEDIA_SELECTION_BUTTONS ? 'hidden' : '') + '\">' +\n                                    '<option value=\"0\">' + strings.option_empty + '</option>' +\n                                    '<option value=\"' + ATTACHMENT_VIDEO + '\">' + strings.option_youtube + '</option>' +\n                                    '<option value=\"' + ATTACHMENT_IMAGE + '\">' + strings.option_image + '</option>' +\n                                    '<option value=\"' + ATTACHMENT_LINK + '\">' + strings.option_link + '</option>' +\n                                '</select>' +\n                                '<span class=\"mod_board_type_icon fa ' + (mediaSelection == MEDIA_SELECTION_DROPDOWN ?\n                                    'hidden' : '') + '\">' +\n                                '</span>' +\n                                '<input type=\"text\" class=\"info form-control form-control-sm col-sm-12 ' +\n                                (mediaSelection == MEDIA_SELECTION_BUTTONS ? 'mod_board_with_type_icon' : '') +\n                                '\" placeholder=\"\">' +\n                                '<input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\">' +\n                                '<div class=\"mod_board_file form-control form-control-sm\"><label for=\"file' + ident +\n                                '\" class=\"choose_file_button mod_board_action_button p-0 w-100\" tabindex=\"0\">' +\n                                strings.choose_file + '</label><input id=\"file' + ident + '\" type=\"file\" class=\"d-none\"></div>' +\n                            '</div>'\n                        );\n\n            noteAttachment.hide();\n        }\n\n        notecontent.append(noteHeading);\n        notecontent.append(noteText);\n        notecontent.append(noteAriaText);\n        if (iseditable) {\n            notecontent.append(noteAttachment);\n        }\n\n        notecontent.append(attachmentPreview);\n        note.append(notecontent);\n\n        if (iseditable) {\n            var attachmentType = noteAttachment.find('.mod_board_type'),\n                attachmentInfo = noteAttachment.find('.info'),\n                attachmentUrl = noteAttachment.find('.url'),\n                attachmentFileInput = noteAttachment.find('.mod_board_file>input');\n\n            attachmentType.on('change', function() {\n                attachmentTypeChanged(note);\n                previewAttachment(note);\n            });\n\n            attachmentUrl.on('change', function() {\n                previewAttachment(note);\n            });\n\n            attachmentFileInput.on('change', function() {\n                preloadFile(note, function() {\n                    previewAttachment(note);\n                });\n            });\n\n            attachmentInfo.on('change', function() {\n                previewAttachment(note);\n            });\n\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                var removeAttachment = $('<div class=\"mod_board_remove mod_board_remove_attachment fa fa-remove\"></div>');\n                removeAttachment.hide();\n                removeAttachment.on('click', function() {\n                    attachmentType.val(0); attachmentType.trigger('change');\n                });\n                noteAttachment.append(removeAttachment);\n            }\n        }\n\n        var column_content = $('.board_column[data-ident=' + columnid + '] .board_column_content');\n\n        if (iseditable) {\n            var buttons = $('<div class=\"mod_board_note_buttons\"></div>');\n            buttons.hide();\n            var postbutton = $('<div class=\"post_button mod_board_action_button\" role=\"button\" tabindex=\"0\">' +\n                              strings.post_button_text + '</div>');\n            var cancelbutton = $('<div class=\"cancel_button mod_board_action_button\" role=\"button\" tabindex=\"0\">' +\n                                strings.cancel_button_text + '</div>');\n\n            buttons.append(postbutton);\n            buttons.append(cancelbutton);\n\n            if (mediaSelection == MEDIA_SELECTION_BUTTONS) {\n                buttons.append('<div class=\"mod_board_spacer_button\"></div>');\n                var ytButton = $('<div class=\"mod_board_attachment_button youtube_button mod_board_action_button fa ' +\n                                attachmentFAIcons[0] + '\" role=\"button\" tabindex=\"0\"></div>');\n                handleAction(ytButton, function() {\n                    attachmentType.val(1); attachmentType.trigger(\"change\");\n                });\n                var imgButton = $('<div class=\"mod_board_attachment_button image_button mod_board_action_button fa ' +\n                                 attachmentFAIcons[1] + '\" role=\"button\" tabindex=\"0\"></div>');\n                handleAction(imgButton, function() {\n                    attachmentType.val(2); attachmentType.trigger(\"change\");\n                });\n                var linkButton = $('<div class=\"mod_board_attachment_button link_button mod_board_action_button fa ' +\n                                  attachmentFAIcons[2] + '\" role=\"button\" tabindex=\"0\"></div>');\n                handleAction(linkButton, function() {\n                    attachmentType.val(3); attachmentType.trigger(\"change\");\n                });\n                buttons.append(ytButton);\n                buttons.append(imgButton);\n                buttons.append(linkButton);\n            }\n\n            note.append(buttons);\n\n            var removeElement = $('<div class=\"mod_board_remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>');\n            handleAction(removeElement, function() {\n                deleteNote(ident);\n            });\n\n            if (!ident) {\n                removeElement.hide();\n            }\n            notecontent.append(removeElement);\n\n            handleAction(cancelbutton, function() {\n                stopNoteEdit();\n            });\n\n            noteText.on('click', function() {\n                if ((editingNote && editingNote == ident) || !ident) {\n                    noteText.editable('open');\n                }\n            });\n\n            var beginEdit = function() {\n                startNoteEdit(ident);\n            };\n\n            noteHeading.on('click', function() {\n                if ((editingNote && editingNote == ident) || !ident) {\n                    noteHeading.editable('open');\n                }\n            });\n\n            attachmentPreview.on('dblclick', beginEdit);\n\n            handleAction(postbutton, function() {\n                var sendAttach = attachmentDataForNote(note);\n\n                noteHeading.editable('close');\n\n                var theHeading = noteHeading.html();\n                noteText.editable('close');\n                var theText = noteText.html().substring(0, options.post_max_length);\n\n                if (!theHeading && !theText && !sendAttach.url && !sendAttach.filename) {\n                    return;\n                }\n\n                if (postbutton.data('disabled')) {\n                    return;\n                }\n\n                postbutton.data('disabled', true);\n\n\n                if (!ident) { // New\n                    serviceCall('add_note', {columnid: columnid, heading: theHeading, content: theText,\n                        attachment: sendAttach}, function(result) {\n                        if (result.status) {\n                            lastHistoryId = result.historyid;\n                            note.remove();\n                            showNewNoteButtons();\n                            addNote(columnid, result.note.id, result.note.heading, result.note.content,\n                                {type: result.note.type, info: result.note.info, url: result.note.url},\n                                {id: result.note.userid}, result.note.timecreated, result.note.rating);\n                            sortNotes(column_content);\n                            updateNoteAria(result.note.id);\n                        } else {\n                            postbutton.data('disabled', false);\n                        }\n                    });\n\n                } else { // Update\n                    serviceCall('update_note', {id: ident, heading: theHeading, content: theText,\n                        attachment: sendAttach}, function(result) {\n                        if (result.status) {\n                            lastHistoryId = result.historyid;\n                            successNoteEdit();\n                            noteText.html(result.note.content);\n                            updateNoteAria(ident);\n                            setAttachment(note, {type: result.note.type, info: result.note.info, url: result.note.url});\n                        }\n                        postbutton.data('disabled', false);\n                    });\n                }\n            });\n\n            handleEditableAction(noteText, beginEdit);\n            noteText.editable({\n                toggleFontSize: false,\n                closeOnEnter: false,\n                callback: function() {\n                    noteText.html(noteText.html().substring(0, options.post_max_length));\n                }\n            });\n\n            handleEditableAction(noteHeading, beginEdit);\n            noteHeading.editable({\n                toggleFontSize: false,\n                closeOnEnter: true\n            });\n\n            setAttachment(note, attachment);\n        } else {\n            previewAttachment(note, attachment);\n        }\n\n        if (ident) {\n            if (ratingenabled) {\n                note.addClass('mod_board_rateablenote');\n                var rateElement = $('<div class=\"fa fa-star mod_board_rating\" role=\"button\" tabindex=\"0\">' + rating + '</div>');\n\n                handleAction(rateElement, function() {\n                    rateNote(ident);\n                });\n                notecontent.append(rateElement);\n            }\n\n            if (!noteHeading.html()) {\n                noteHeading.hide();\n            }\n            var lastOne = column_content.find(\".board_note\").last();\n            if (lastOne.length) {\n                note.insertAfter(lastOne);\n            } else {\n                column_content.prepend(note);\n            }\n        } else {\n            $('.board_column[data-ident=' + columnid + '] .board_column_newcontent').append(note);\n            updateNoteAria(ident);\n            noteText.editable('open'); // Trigger edit of note\n            beginEdit();\n        }\n    };\n\n    /**\n     * Add a new column.\n     *\n     * @method addColumn\n     * @param ident\n     * @param name\n     * @param notes\n     */\n    var addColumn = function(ident, name, notes) {\n        var iseditable = isEditor,\n            nameCache = null,\n            column = $('<div class=\"board_column board_column_hasdata\" data-ident=\"' + ident + '\"></div>'),\n            columnHeader = $('<div class=\"board_column_header\"></div>'),\n            columnSort = $('<div class=\"mod_board_column_sort fa\"></div>'),\n            columnName = $('<div class=\"mod_board_column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">' + name + '</div>'),\n            columnContent = $('<div class=\"board_column_content\"></div>'),\n            columnNewContent = $('<div class=\"board_column_newcontent\"></div>');\n        columnHeader.append(columnSort);\n        columnHeader.append(columnName);\n\n        if (options.hideheaders) {\n            columnName.addClass('d-none');\n        }\n\n        columnSort.on('click', function() {\n            sortNotes(columnContent, true);\n        });\n\n        if (iseditable) {\n            column.addClass('mod_board_editablecolumn');\n\n            var removeElement = $('<div class=\"mod_board_remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>');\n            handleAction(removeElement, function() {\n                Notification.confirm(\n                    strings.remove_column_title, // Are you sure?\n                    strings.remove_column_text, // This will effect others.\n                    strings.Ok,\n                    strings.Cancel,\n                    function() {\n                        serviceCall('delete_column', {id: ident}, function(result) {\n                            if (result.status) {\n                                column.remove();\n                                lastHistoryId = result.historyid;\n                            }\n                        });\n                    }\n                );\n            });\n\n            columnHeader.append(removeElement);\n        }\n\n        column.append(columnHeader);\n        column.append(columnContent);\n        column.append(columnNewContent);\n\n        if (iseditable) {\n            handleEditableAction(columnName, function() {\n                nameCache = columnName.html();\n            }, true);\n\n            columnName.editable({\n                toggleFontSize: false,\n                closeOnEnter: true,\n                callback: function(data) {\n                    if (data.content) {\n                        serviceCall('update_column', {id: ident, name: columnName.html()}, function(result) {\n                            if (!result.status) {\n                                columnName.html(nameCache);\n                                nameCache = null;\n                            } else {\n                                lastHistoryId = result.historyid;\n                                updateColumnAria(ident);\n                            }\n                        }, function() {\n                            columnName.html(nameCache);\n                            nameCache = null;\n                        });\n                    } else {\n                        columnName.html(nameCache);\n                        nameCache = null;\n                    }\n                }\n            });\n        }\n\n        if (!isReadOnlyBoard) {\n            columnNewContent.append('<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\">' +\n            '<div class=\"button_content\"><span class=\"fa ' + options.noteicon + '\"></span></div></div>');\n\n            handleAction(columnNewContent.find('.newnote'), function() {\n                addNote(ident, 0, null, null, null, {id: userId}, 0, 0);\n            });\n        }\n\n        var lastOne = $(\".mod_board .board_column_hasdata\").last();\n        if (lastOne.length) {\n            column.insertAfter(lastOne);\n        } else {\n            $(\".mod_board\").append(column);\n        }\n\n        if (notes) {\n            for (var index in notes) {\n                addNote(ident, notes[index].id, notes[index].heading, notes[index].content,\n                    {type: notes[index].type, info: notes[index].info, url: notes[index].url},\n                    {id: notes[index].userid}, notes[index].timecreated, notes[index].rating);\n            }\n        }\n        sortNotes(columnContent);\n        updateColumnAria(ident);\n        if (isEditor) {\n            updateSortable();\n        }\n    };\n\n    /**\n     * Add the new column button.\n     *\n     * @method addNewColumnButton\n     */\n    var addNewColumnButton = function() {\n        var column = $('<div class=\"board_column board_column_empty\"></div>'),\n            newBusy = false;\n        column.append('<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\"' +\n        strings.aria_newcolumn + '\"><div class=\"button_content\"><span class=\"fa ' + options.columnicon +\n        '\"></span></div></div>');\n\n        handleAction(column.find('.newcolumn'), function() {\n            if (newBusy) {\n                return;\n            }\n            newBusy = true;\n\n            serviceCall('add_column', {boardid: board.id, name: strings.default_column_heading}, function(result) {\n                addColumn(result.id, strings.default_column_heading);\n                lastHistoryId = result.historyid;\n                newBusy = false;\n            }, function() {\n                newBusy = false;\n            });\n        });\n\n        $(\".mod_board\").append(column);\n    };\n\n    /**\n     * Update a note with the provided information.\n     *\n     * @method updateNote\n     * @param note\n     * @param heading\n     * @param data\n     */\n    var updateNote = function(note, heading, data) {\n        heading.html(data.heading);\n        if (data.heading) {\n            heading.show();\n        } else {\n            heading.hide();\n        }\n        getNoteTextForNote(note).html(data.content);\n        setAttachment(note, data.attachment);\n        noteTextCache = null;\n        noteHeadingCache = null;\n        attachmentCache = null;\n        updateNoteAria(data.id);\n    };\n\n    /**\n     * Fetch and process the recent board history.\n     *\n     * @method processBoardHistory\n     */\n    var processBoardHistory = function() {\n        serviceCall('board_history', {id: board.id, since: lastHistoryId}, function(boardhistory) {\n            for (var index in boardhistory) {\n                var item = boardhistory[index];\n                if (item.boardid != board.id) {\n                    continue; // Hmm\n                }\n\n                var data = JSON.parse(item.content);\n                if (item.action == 'add_note') {\n                    addNote(data.columnid, data.id, data.heading, data.content, data.attachment,\n                        {id: item.userid}, data.timecreated, data.rating);\n                    updateNoteAria(data.id);\n                    sortNotes($('.board_column[data-ident=' + data.columnid + '] .board_column_content'));\n                } else if (item.action == 'update_note') {\n                    var note = getNote(data.id);\n                    if (note) {\n                        var heading = getNoteHeadingForNote(note);\n\n                        if (editingNote == data.id) {\n                            Notification.confirm(\n                                strings.note_changed_title,\n                                strings.note_changed_text,\n                                strings.Ok,\n                                strings.Cancel,\n                                function(note, heading, data) {\n                                    updateNote(note, heading, data);\n                                    stopNoteEdit();\n                                }\n                            );\n                        } else {\n                            updateNote(note, heading, data);\n                        }\n                    }\n                } else if (item.action == 'delete_note') {\n                    if (editingNote == data.id) {\n                        Notification.alert(strings.warning, strings.note_deleted_text);\n                        stopNoteEdit();\n                    }\n                    getNote(data.id).remove();\n\n                } else if (item.action == 'add_column') {\n                    addColumn(data.id, data.name);\n                } else if (item.action == 'update_column') {\n                    $(\".board_column[data-ident='\" + data.id + \"'] .mod_board_column_name\").html(data.name);\n                    updateColumnAria(data.id);\n                } else if (item.action == 'delete_column') {\n                    var column = $(\".board_column[data-ident='\" + data.id + \"']\");\n                    if (editingNote && column.find('.board_note[data-ident=\"' + editingNote + '\"]').length) {\n                        stopNoteEdit();\n                    }\n                    column.remove();\n                } else if (item.action == 'rate_note') {\n                    var note = getNote(data.id);\n                    note.find('.mod_board_rating').html(data.rating);\n                    if (sortby == SORTBY_RATING) {\n                        sortNotes(note.closest('.board_column_content'));\n                    }\n                }\n                lastHistoryId = item.id;\n            }\n\n            updateBoard();\n        });\n    };\n\n    /**\n     * Trigger a board update.\n     *\n     * @method updateBoard\n     * @param instant\n     */\n    var updateBoard = function(instant) {\n        if (instant) {\n            processBoardHistory();\n        } else if (options.history_refresh > 0) {\n            if (reloadTimer) {\n                stopUpdating();\n            }\n            reloadTimer = setTimeout(processBoardHistory, options.history_refresh * 1000);\n        }\n    };\n\n    /**\n     * Stop/prevent the board reload timer from firing.\n     *\n     * @method stopUpdating\n     */\n    var stopUpdating = function() {\n        clearTimeout(reloadTimer);\n        reloadTimer = null;\n    };\n\n    /**\n     * Sort a set of notes.\n     *\n     * @sortNotes\n     * @param content\n     * @param toggle\n     */\n    var sortNotes = function(content, toggle) {\n        var sortCol = $(content).parent().find('.mod_board_column_sort'),\n            direction = $(content).data('sort');\n        if (!direction) {\n            if (sortby == SORTBY_RATING) {\n                direction = 'desc';\n            } else {\n                direction = 'asc';\n            }\n        }\n        if (toggle) {\n            direction = direction == 'asc' ? 'desc' : 'asc';\n        }\n\n        if (direction == 'asc') {\n            sortCol.removeClass('fa-angle-down');\n            sortCol.addClass('fa-angle-up');\n        } else {\n            sortCol.removeClass('fa-angle-up');\n            sortCol.addClass('fa-angle-down');\n        }\n        $(content).data('sort', direction);\n\n        var desc,\n            asc;\n        if (sortby == SORTBY_DATE) {\n            desc = function(a, b) {\n                return $(b).data(\"sortorder\") - $(a).data(\"sortorder\");\n            };\n            asc = function(a, b) {\n                return $(a).data(\"sortorder\") - $(b).data(\"sortorder\");\n            };\n        } else {\n            desc = function(a, b) {\n                return $(b).find('.mod_board_rating').text() - $(a).find('.mod_board_rating').text() ||\n                $(b).data(\"sortorder\") - $(a).data(\"sortorder\");\n            };\n            asc = function(a, b) {\n                return $(a).find('.mod_board_rating').text() - $(b).find('.mod_board_rating').text() ||\n                $(a).data(\"sortorder\") - $(b).data(\"sortorder\");\n            };\n        }\n\n        $('> .board_note', $(content)).sort(direction === 'asc' ? asc : desc).appendTo($(content));\n\n    };\n\n    /**\n     * Update sorting of sortable content.\n     *\n     * @method updateSortable\n     */\n    var updateSortable = function() {\n        $(\".board_column_content\").sortable({\n            connectWith: \".board_column_content\",\n            stop: function(e, ui) {\n                var note = $(ui.item),\n                    tocolumn = note.closest('.board_column'),\n                    columnid = tocolumn.data('ident'),\n                    elem = $(this);\n\n                serviceCall('move_note', {id: note.data('ident'), columnid: columnid}, function(result) {\n                    if (result.status) {\n                        lastHistoryId = result.historyid;\n                        updateNoteAria(note.data('ident'));\n                        sortNotes($('.board_column[data-ident=' + columnid + '] .board_column_content'));\n                    } else {\n                        elem.sortable('cancel');\n                    }\n                });\n            }\n        });\n    };\n\n    /**\n     * Initialize board.\n     *\n     * @method init\n     */\n    var init = function() {\n        serviceCall('get_board', {id: board.id}, function(columns) {\n            // Init\n            if (columns) {\n                for (var index in columns) {\n                    addColumn(columns[index].id, columns[index].name, columns[index].notes || {});\n                }\n            }\n\n            if (isEditor) {\n                addNewColumnButton();\n            }\n\n            lastHistoryId = board.historyid;\n\n            if (isEditor) {\n                updateSortable();\n            }\n\n            updateBoard();\n        });\n    };\n\n    // Get strings\n    var stringsInfo = [];\n    for (var string in strings) {\n        stringsInfo.push({key: string, component: 'mod_board'});\n    }\n\n    $.when(getStrings(stringsInfo)).done(function(results) {\n        var index = 0;\n        for (string in strings) {\n            strings[string] = results[index++];\n        }\n\n        init();\n    });\n}\n"],"file":"board.min.js"}